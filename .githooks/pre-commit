#!/usr/bin/env bash
set -euo pipefail

echo "--- pre-commit: running checks ---"

REPO_ROOT="$(git rev-parse --show-toplevel)"

# 1. Strip registry URL 'resolved' entries from all package-lock.json files.
# Keep local workspace "resolved" paths (e.g. "apps/shared-ui") because npm
# needs them to resolve workspace links.
for lockfile in \
  "$REPO_ROOT/package-lock.json" \
  "$REPO_ROOT/apps/server-ui/package-lock.json" \
  "$REPO_ROOT/apps/receiver-ui/package-lock.json"; do
  if [ -f "$lockfile" ] && command -v jq &>/dev/null; then
    echo "  Cleaning registry resolved fields from ${lockfile##$REPO_ROOT/} ..."
    jq 'walk(
      if type == "object" then
        with_entries(
          select(
            .key != "resolved" or
            (.value | type) != "string" or
            (.value | test("^https?://") | not)
          )
        )
      else .
      end
    )' \
      "$lockfile" > /tmp/package-lock-clean.json && \
    mv /tmp/package-lock-clean.json "$lockfile"
    git add "$lockfile"
  fi
done

# 2. Rust formatting check
echo "  Checking Rust formatting ..."
cd "$REPO_ROOT" && cargo fmt --all -- --check

# 3. Rust linting
echo "  Running clippy ..."
cd "$REPO_ROOT" && cargo clippy --workspace --all-targets

run_js_checks() {
  local app_dir="$1"
  local app_name="${app_dir##$REPO_ROOT/}"

  if [ ! -d "$REPO_ROOT/node_modules" ]; then
    echo "  ERROR: dependencies are not installed."
    echo "  Run: npm ci"
    exit 1
  fi

  echo "  Running $app_name lint ..."
  (cd "$app_dir" && npm run lint)
  echo "  Running $app_name type check ..."
  (cd "$app_dir" && npm run check)
}

staged_files="$(git diff --cached --name-only --diff-filter=ACMR)"

# 4. JS/TS checks for touched frontend apps (blocking)
if echo "$staged_files" | grep -q '^apps/server-ui/'; then
  run_js_checks "$REPO_ROOT/apps/server-ui"
fi

if echo "$staged_files" | grep -q '^apps/forwarder-ui/'; then
  run_js_checks "$REPO_ROOT/apps/forwarder-ui"
fi

if echo "$staged_files" | grep -q '^apps/receiver-ui/'; then
  run_js_checks "$REPO_ROOT/apps/receiver-ui"
fi

echo "--- pre-commit: all checks passed ---"

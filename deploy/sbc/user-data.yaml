#cloud-config
# deploy/sbc/user-data.yaml
#
# cloud-init user-data template for Raspberry Pi running rt-forwarder.
#
# BEFORE FLASHING: Edit the lines marked CHANGEME below, and edit
# network-config for the static IP address.
#
# How to use:
#   1. Flash Raspberry Pi OS (64-bit, Lite) with Raspberry Pi Imager
#   2. Edit this file (hostname + SSH admin username + SSH key)
#   3. Edit network-config (static IP, gateway, DNS)
#   4. Copy both files to the SD card boot partition:
#        - this file as "user-data"
#        - network-config as "network-config"
#   5. Boot the Pi â€” cloud-init runs on first boot
#   6. SSH in and run rt-setup.sh to install the forwarder
#
# See deploy/sbc/README.md for full instructions.

# CHANGEME: Set a unique hostname for this device (e.g. rt-fwd-01)
hostname: rt-fwd-01
manage_etc_hosts: true
enable_ssh: true
ssh_pwauth: false

# Users:
# - SSH admin user for remote access and sudo
# - rt-forwarder service user (non-login, dedicated)
users:
  # CHANGEME: SSH login user (for example, rt-admin)
  - name: rt-admin
    groups: sudo
    shell: /bin/bash
    lock_passwd: true
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      # CHANGEME: Replace with your SSH public key.
      - ssh-ed25519 AAAA_YOUR_KEY_HERE user@host

  - name: rt-forwarder
    system: true
    shell: /bin/false
    homedir: /var/lib/rusty-timer
    no_create_home: false

# Ensure required packages are present.
packages:
  - avahi-daemon
  - ca-certificates
  - jq

# Create required directories and set ownership.
runcmd:
  - mkdir -p /etc/rusty-timer
  - mkdir -p /var/lib/rusty-timer
  - chown rt-forwarder:rt-forwarder /var/lib/rusty-timer
